<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Top Albums Spotify</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #121212;
      color: white;
    }
    header {
      padding: 20px;
      background: #1db954;
    }
    #albums-container {
      display: grid;
      gap: 10px;
      padding: 20px;
    }
    #albums-container div {
      cursor: pointer;
      padding: 10px;
      background: #282828;
      border-radius: 6px;
    }
    #albums-container div:hover {
      background: #333;
    }
    #player-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #181818;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    #track-info {
      margin-bottom: 6px;
      font-size: 14px;
    }
    #player-controls {
      display: flex;
      gap: 25px;
      align-items: center;
      justify-content: center;
    }
    #player-controls button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
    }
    #progress-bar {
      width: 80%;
      margin-top: 8px;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #222;
      color: #fff;
      padding: 20px;
      border-radius: 10px;
      z-index: 9999;
      max-height: 70vh;
      overflow-y: auto;
      width: 300px;
    }
    .popup div {
      margin: 5px 0;
      cursor: pointer;
    }
    .popup button {
      margin-top: 10px;
      background: #1db954;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <button id="login-btn">Log in with Spotify</button>
  </header>

  <main>
    <h1 style="padding:20px;">Albums</h1>
    <div id="albums-container"></div>
  </main>

  <!-- Bottom player bar -->
  <div id="player-bar">
    <div id="track-info">No track</div>
    <div id="player-controls">
      <button id="prev-btn">⏮️</button>
      <button id="play-pause-btn">▶️</button>
      <button id="next-btn">⏭️</button>
    </div>
    <input id="progress-bar" type="range" min="0" max="100" value="0">
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    let accessToken = null;
    let player;
    let deviceId;
    let progressInterval;

    const loginBtn = document.getElementById("login-btn");
    const trackInfo = document.getElementById("track-info");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const progressBar = document.getElementById("progress-bar");

    // ================= LOGIN FLOW =================
    async function generateCodeVerifier(length) {
      let text = "";
      const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }

    async function generateCodeChallenge(codeVerifier) {
      const data = new TextEncoder().encode(codeVerifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function redirectToSpotify() {
      const verifier = await generateCodeVerifier(128);
      const challenge = await generateCodeChallenge(verifier);

      localStorage.setItem("code_verifier", verifier);

      const params = new URLSearchParams({
        response_type: "code",
        client_id: "8d7b599ddbef4be296e05e04728908ce",
        scope: "user-modify-playback-state user-read-playback-state streaming",
        redirect_uri: "https://top-albums.netlify.app",
        code_challenge_method: "S256",
        code_challenge: challenge,
      });

      window.location = `https://accounts.spotify.com/authorize?${params}`;
    }

    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");

      if (code) {
        const verifier = localStorage.getItem("code_verifier");
        const res = await fetch(`/.netlify/functions/spotify-auth?code=${encodeURIComponent(code)}&verifier=${encodeURIComponent(verifier)}`);
        const data = await res.json();

        accessToken = data.access_token;
        localStorage.setItem("access_token", accessToken);

        window.history.replaceState({}, document.title, "/");
        updateLoginUI();
        initializePlayer();
      } else {
        accessToken = localStorage.getItem("access_token");
        if (accessToken) {
          updateLoginUI();
          initializePlayer();
        }
      }
    }

    async function updateLoginUI() {
      if (!accessToken) return;
      const res = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const user = await res.json();

      loginBtn.textContent = `Logged in as ${user.display_name}`;
      loginBtn.disabled = true;

      const logoutBtn = document.createElement("button");
      logoutBtn.textContent = "Logout";
      logoutBtn.style.marginLeft = "10px";
      logoutBtn.onclick = () => {
        localStorage.clear();
        window.location.reload();
      };

      loginBtn.insertAdjacentElement("afterend", logoutBtn);
    }

    loginBtn.onclick = redirectToSpotify;
    window.onload = handleRedirect;

    // ================= PLAYER =================
    window.onSpotifyWebPlaybackSDKReady = () => {
      console.log("Spotify SDK Ready");
    };

    function initializePlayer() {
      if (!accessToken) return;

      player = new Spotify.Player({
        name: "Top Albums Player",
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.5
      });

      player.addListener("ready", ({ device_id }) => {
        console.log("Ready with Device ID", device_id);
        deviceId = device_id;
      });

      player.addListener("player_state_changed", state => {
        if (!state) return;
        const current = state.track_window.current_track;
        trackInfo.textContent = `${current.name} – ${current.artists[0].name}`;
        playPauseBtn.textContent = state.paused ? "▶️" : "⏸️";

        clearInterval(progressInterval);
        const duration = state.duration;
        progressBar.max = duration;

        progressInterval = setInterval(() => {
          player.getCurrentState().then(state => {
            if (!state) return;
            progressBar.value = state.position;
          });
        }, 1000);
      });

      player.connect();

      playPauseBtn.onclick = () => player.togglePlay();
      prevBtn.onclick = () => player.previousTrack();
      nextBtn.onclick = () => player.nextTrack();
      progressBar.addEventListener("input", e => {
        player.seek(e.target.value);
      });
    }

    // ================= ALBUMS =================
    document.getElementById("albums-container").innerHTML = `
      <div onclick="openAlbumPopup('1ATL5GLyefJaxhQzSPVrLX')">Dua Lipa – Future Nostalgia</div>
      <div onclick="openAlbumPopup('3RQQmkQEvNCY4prGKE6oc5')">Billie Eilish – WHEN WE ALL FALL ASLEEP</div>
    `;

    function playAlbum(uri) {
      fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        body: JSON.stringify({ context_uri: uri }),
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`
        }
      });
    }

    function playTrack(trackUri) {
      fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        body: JSON.stringify({ uris: [trackUri] }),
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${accessToken}`
        }
      });
    }

    function openAlbumPopup(albumId) {
      if (!accessToken) {
        alert("Please login first");
        return;
      }

      const popup = document.createElement("div");
      popup.className = "popup";
      popup.innerHTML = `<h2>Album Tracks</h2><div id="tracklist">Loading...</div><button onclick="this.parentNode.remove()">Close</button>`;
      document.body.appendChild(popup);

      fetch(`https://api.spotify.com/v1/albums/${albumId}/tracks?limit=50`, {
        headers: { Authorization: `Bearer ${accessToken}` }
      })
        .then(r => r.json())
        .then(data => {
          const tracklist = popup.querySelector("#tracklist");
          tracklist.innerHTML = "";
          data.items.forEach(track => {
            const div = document.createElement("div");
            div.textContent = `${track.track_number}. ${track.name}`;
            div.onclick = () => playTrack(track.uri);
            tracklist.appendChild(div);
          });
        });
    }
  </script>
</body>
</html>

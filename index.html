<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>My Best Albums</title>
  <style>
    /* Your full existing CSS here (unchanged) */
  </style>
</head>
<body>
<header>
  Top Albums by Year
  <button class="decade-btn" onclick="scrollToDecade('199')">1990s</button>
  <button class="decade-btn" onclick="scrollToDecade('200')">2000s</button>
  <button class="decade-btn" onclick="scrollToDecade('201')">2010s</button>
  <button class="decade-btn" onclick="scrollToDecade('202')">2020s</button>
  <div class="spacer"></div>
  <button id="loginBtn" class="login-btn">Log in with Spotify</button>
</header>

<div class="main-container">
  <div class="rank-column" id="rankColumn">
    <div id="rankScroller"></div>
  </div>
  <div class="years-container" id="yearsContainer"></div>
</div>

<!-- Modal -->
<div id="albumModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <img id="modalCover" src="" alt="">
      <div class="modal-title">
        <div class="name" id="modalAlbumName"></div>
        <div class="artist" id="modalArtistName"></div>
      </div>
      <div style="margin-left:auto;">
        <button id="modalPlayBtn" class="login-btn" style="padding:6px 12px;">Play</button>
      </div>
    </div>
    <div class="tracks" id="tracksList"></div>
    <div class="modal-actions">
      <button id="closeModalBtn" class="close-btn">Close</button>
    </div>
  </div>
</div>

<!-- Bottom Player Bar -->
<div class="player-bar">
  <div class="track-info" id="barInfo">
    <img id="barCover" src="" alt="Album Cover" />
    <div class="track-text">
      <div id="barTrack" class="track-name">—</div>
      <div id="barArtist" class="track-artist">—</div>
    </div>
  </div>

  <div class="controls">
    <button id="prevBtn" class="ctrl-btn" title="Previous">⏮️</button>
    <button id="playPauseBtn" class="ctrl-btn" title="Play/Pause">▶️</button>
    <button id="nextBtn" class="ctrl-btn" title="Next">⏭️</button>
    <div class="progress-container">
      <span id="currentTime">0:00</span>
      <input type="range" id="progressBar" min="0" max="100" value="0">
      <span id="totalTime">0:00</span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
/* ===================== CONFIG ===================== */
const CONFIG = {
  SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS87YVlo7KZGqRzYWLfgmiyzu2SkcP3Rj0kmZb5yN3xqFbNDgBpmCY7hkrsVWsrwq1NlgGuZRg6uHR3/pub?gid=1476054055&single=true&output=csv",
  SPOTIFY_CLIENT_ID: "8d7b599ddbef4be296e05e04728908ce",
  REDIRECT_URI: "https://top-albums.netlify.app",
  BACKEND_FUNCTION_URL: "/.netlify/functions/spotify-auth"
};

let token = null;
let refreshToken = null;
let albumsData = [];
let player = null;
let deviceId = null;

// ===================== DOM ELEMENTS (DECLARED EARLY) =====================
const progressBar = document.getElementById("progressBar");
const currentTimeEl = document.getElementById("currentTime");
const totalTimeEl = document.getElementById("totalTime");
const barInfo = document.getElementById("barInfo");

/* ===================== DATA LOAD ===================== */
async function fetchAlbums() {
  // unchanged
}

/* ===================== AUTH (PKCE) ===================== */
function authenticateSpotify() {
  // unchanged
}

async function handleAuthRedirect() {
  // unchanged
}

/* ===================== SPOTIFY WEB PLAYBACK SDK ===================== */
window.onSpotifyWebPlaybackSDKReady = () => {
  initPlayerIfPossible();
};

function initPlayerIfPossible() {
  if (!window.Spotify) return;
  if (!token) return;
  if (player) return;

  player = new Spotify.Player({
    name: 'Top Albums Web Player',
    getOAuthToken: cb => { cb(token); },
    volume: 0.7
  });

  player.addListener('player_state_changed', state => {
    if (!state) return;
    updateBarFromState(state);
    document.getElementById('playPauseBtn').textContent = state.paused ? "▶️" : "⏸️";
  });

  progressBar.addEventListener("input", async (e) => {
    if (!player) return;
    const percent = e.target.value;
    const state = await player.getCurrentState();
    if (!state) return;
    const duration = state.track_window.current_track.duration_ms;
    const newPos = Math.floor(duration * (percent / 100));
    player.seek(newPos);
  });

  barInfo.addEventListener("click", () => {
    if (currentAlbumUri) showModal();
  });

  player.connect();
}

// ===================== PLAYBACK BAR CONTROL FUNCTIONS =====================
function updateBarFromState(state) {
  const current = state.track_window.current_track;
  if (!current) return;
  const cover = current.album.images?.[0]?.url || "";
  document.getElementById("barCover").src = cover;
  document.getElementById("barTrack").textContent = current.name || "—";
  document.getElementById("barArtist").textContent = (current.artists?.[0]?.name) || "—";
  const duration = current.duration_ms;
  totalTimeEl.textContent = formatTime(duration);
  currentTimeEl.textContent = formatTime(state.position);
  progressBar.value = Math.min(100, (state.position / duration) * 100);
}

function formatTime(ms) {
  const totalSec = Math.floor(ms/1000);
  const mins = Math.floor(totalSec/60);
  const secs = totalSec % 60;
  return `${mins}:${secs.toString().padStart(2,'0')}`;
}

/* ===================== BOOT ===================== */
window.onload = async () => {
  await handleAuthRedirect();
  fetchAlbums();
};
</script>
</body>
</html>

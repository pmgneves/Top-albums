<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Best Albums</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #111;
        color: white;
        overflow-x: auto;
        overflow-y: auto;
      }
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: #111;
        display: flex;
        align-items: center;
        padding: 0 20px;
        font-size: 20px;
        z-index: 100;
        gap: 15px;
        border-bottom: 2px solid #222;
      }
      .decade-btn {
        background: #222;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 14px;
      }

      .main-container {
        display: flex;
        margin-top: 0px;
      }

      .rank-column {
        position: fixed;
        left: 0;
        top: 50px;
        width: 30px;
        bottom: 0;
        background: #111;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }

      /* rows driven by JS-calculated --row-h */
      #rankScroller {
        will-change: transform;
        display: grid;
        grid-auto-rows: var(--row-h, 252px);
        padding-top: 0; /* JS will set exact top offset */
      }

      .rank-number {
        height: var(--row-h, 252px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #ffffff;
        box-sizing: border-box;
        width: 100%;
        position: relative;
        z-index: 5; /* above the background stripes */
      }

      .years-container {
        display: flex;
        align-items: flex-start;
        padding: 0px 10px 10px 60px;
        gap: 20px;
        position: relative; /* for the full-width striped background */
      }

      .year-column {
        flex: 0 0 auto;
        width: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }

      .year-title {
        position: sticky;
        top: 50px;
        font-size: 16px;
        font-weight: bold;
        background: #111;
        padding: 8px 5px;
        border-radius: 5px;
        text-align: center;
        width: 100%;
        z-index: 10;
      }

      .albums-wrapper {
        margin-top: 10px;
        padding-top: 50px; /* PUSH DOWN albums so they don't overlap sticky year-title */
        position: relative;
      }

      /* ========== IMPORTANT: 5px top spacing so background shows behind album ========== */
      .album {
        width: 100%;
        height: auto; /* let the content define the height */
        margin-top: 5px; /* <-- top breathing space */
        margin-bottom: 0;
        cursor: pointer;
        position: relative; /* ensure album content sits above the background stripes */
        z-index: 6; /* above the striped background so everything is visible */
      }

      .album img,
      .album .no-cover {
        width: 100%;
        height: 180px; /* fixed cover height */
        display: block;
        padding: 0;
        margin: 0;
        border-radius: 8px;
      }

      .album-info {
        height: 72px; /* 4 lines: 18px each */
        margin: 0;
        padding-top: 4px;
        font-size: 13px;
        line-height: 18px;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }

      /* Shared background for albums + rank numbers (unchanged for 1-3 and 11-20) */
      .albums-wrapper .album:nth-child(1),
      #rankScroller .rank-number:nth-child(1) {
        background: rgba(212, 175, 55, 0.2);
        box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
      }
      .albums-wrapper .album:nth-child(2),
      #rankScroller .rank-number:nth-child(2) {
        background: rgba(192, 192, 192, 0.2);
        box-shadow: 0 0 8px rgba(192, 192, 192, 0.5);
      }
      .albums-wrapper .album:nth-child(3),
      #rankScroller .rank-number:nth-child(3) {
        background: rgba(205, 127, 50, 0.2);
        box-shadow: 0 0 8px rgba(205, 127, 50, 0.5);
      }

      /* ===== CHANGED: rows 4-10 now lighter blue (closer to 11-20 but lighter) ===== */
      .albums-wrapper .album:nth-child(n + 4):nth-child(-n + 10),
      #rankScroller .rank-number:nth-child(n + 4):nth-child(-n + 10) {
        background: rgba(140, 184, 245, 0.15); /* lighter blue */
        box-shadow: 0 0 6px rgba(140, 184, 245, 0.35);
      }

      /* 11-20 remains the original cornflower blue */
      .albums-wrapper .album:nth-child(n + 11):nth-child(-n + 20),
      #rankScroller .rank-number:nth-child(n + 11):nth-child(-n + 20) {
        background: rgba(100, 149, 237, 0.15);
        box-shadow: 0 0 6px rgba(100, 149, 237, 0.4);
      }

      /*
        Full-width striped background (blurred edges + mask).
        Updated to use the new lighter-blue for the 4-10 band so background stripe matches objects.
      */
      .years-container::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: var(
          --rows-offset,
          0px
        ); /* offset to where first album starts (relative to yearsContainer) */
        height: var(
          --stripe-cover,
          0px
        ); /* cover only N rows (N = min(totalAlbums, 20)) */
        z-index: 1; /* behind albums but above page background */
        pointer-events: none;

        /* updated band colors: gold, silver, bronze, LIGHTER-BLUE (4-10), CORNFLOWER-BLUE (11-20) */
        background-image: linear-gradient(
          to bottom,
          rgba(212, 175, 55, 0.2) 0%,
          rgba(212, 175, 55, 0.2) 5%,
          rgba(192, 192, 192, 0.2) 5%,
          rgba(192, 192, 192, 0.2) 10%,
          rgba(205, 127, 50, 0.2) 10%,
          rgba(205, 127, 50, 0.2) 15%,
          rgba(140, 184, 245, 0.15) 15%,
          rgba(140, 184, 245, 0.15) 50%,
          rgba(100, 149, 237, 0.15) 50%,
          rgba(100, 149, 237, 0.15) 100%
        );

        /* tile height = 20 * row height (set from JS) */
        background-size: 100% var(--stripe-block, 4000px);
        background-repeat: no-repeat; /* do NOT repeat beyond the cover height */

        /* subtle blur so the stripe edges fade under album rounded corners / margins */
        filter: blur(6px) saturate(1.05);
        opacity: 0.95;

        /* mask edges left/right so the stripe visually fades into the page margins */
        -webkit-mask-image: linear-gradient(
          to right,
          transparent 0px,
          rgba(0, 0, 0, 1) 60px,
          rgba(0, 0, 0, 1) calc(100% - 60px),
          transparent 100%
        );
        mask-image: linear-gradient(
          to right,
          transparent 0px,
          rgba(0, 0, 0, 1) 60px,
          rgba(0, 0, 0, 1) calc(100% - 60px),
          transparent 100%
        );
      }
    </style>
  </head>
  <body>
    <header>
      Top Albums by Year
      <button class="decade-btn" onclick="scrollToDecade('199')">1990s</button>
      <button class="decade-btn" onclick="scrollToDecade('200')">2000s</button>
      <button class="decade-btn" onclick="scrollToDecade('201')">2010s</button>
      <button class="decade-btn" onclick="scrollToDecade('202')">2020s</button>
    </header>

    <div class="main-container">
      <div class="rank-column" id="rankColumn">
        <div id="rankScroller"></div>
      </div>

      <div class="years-container" id="yearsContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
      const CONFIG = {
        SHEET_CSV_URL:
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vS87YVlo7KZGqRzYWLfgmiyzu2SkcP3Rj0kmZb5yN3xqFbNDgBpmCY7hkrsVWsrwq1NlgGuZRg6uHR3/pub?gid=1476054055&single=true&output=csv",
        SPOTIFY_CLIENT_ID: "8d7b599ddbef4be296e05e04728908ce",
        REDIRECT_URI: "https://My-Best-Albums.com/",
      };

      let token = null;
      let albumsData = [];

      async function fetchAlbums() {
        try {
          const response = await fetch(CONFIG.SHEET_CSV_URL);
          const text = await response.text();
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              albumsData = results.data;
              renderAlbums();
            },
          });
        } catch (err) {
          console.error("Error fetching CSV:", err);
        }
      }

      function renderAlbums() {
        const container = document.getElementById("yearsContainer");
        const rankScroller = document.getElementById("rankScroller");
        container.innerHTML = "";
        rankScroller.innerHTML = "";

        const years = [...new Set(albumsData.map((a) => a.Year))].sort();
        let globalRank = 1;

        years.forEach((year) => {
          const yearCol = document.createElement("div");
          yearCol.className = "year-column";

          const yearDiv = document.createElement("div");
          yearDiv.className = "year-title";
          yearDiv.innerText = year;
          yearCol.appendChild(yearDiv);

          const albumsWrapper = document.createElement("div");
          albumsWrapper.className = "albums-wrapper";

          const albumsOfYear = albumsData
            .filter((a) => a.Year === year)
            .sort((a, b) => Number(a.Rank) - Number(b.Rank));

          albumsOfYear.forEach((a) => {
            const [artist, albumTitle] = (
              a["Album-Artist"]?.split(" - ") || ["Unknown", "Unknown"]
            ).map((s) => s.trim());
            const div = document.createElement("div");
            div.className = "album";

            let infoDiv = document.createElement("div");
            infoDiv.className = "album-info";
            infoDiv.innerHTML = `${albumTitle}<br><small>${artist}</small>`;

            div.appendChild(
              a.CoverURL ? createCoverImg(a.CoverURL) : createNoCover()
            );
            div.appendChild(infoDiv);
            div.onclick = () => playAlbum(a.SpotifyURI);

            albumsWrapper.appendChild(div);

            const rankDiv = document.createElement("div");
            rankDiv.className = "rank-number";
            rankDiv.innerText = globalRank++;
            rankScroller.appendChild(rankDiv);
          });

          yearCol.appendChild(albumsWrapper);
          container.appendChild(yearCol);
        });

        // After DOM is painted, measure and sync rank layout & background
        requestAnimationFrame(syncRankMetrics);
      }

      // Measure first album and sync rank scroller spacing & offset
      function syncRankMetrics() {
        const firstAlbum = document.querySelector(".albums-wrapper .album");
        const rankScroller = document.getElementById("rankScroller");
        const firstYearTitle = document.querySelector(".year-title");
        const yearsContainer = document.getElementById("yearsContainer");
        if (!firstAlbum || !rankScroller || !firstYearTitle || !yearsContainer)
          return;

        // measured album content height (does NOT include margin)
        const albumContentH = firstAlbum.getBoundingClientRect().height;

        // read computed top margin (we added margin-top:5px above)
        const albumMarginTop = parseFloat(
          getComputedStyle(firstAlbum).marginTop || "0"
        );

        // total visual row height that should drive rows and stripes
        const totalRowH = albumContentH + albumMarginTop;

        // set row height used by the rank grid
        rankScroller.style.setProperty("--row-h", totalRowH + "px");
        rankScroller.style.gridAutoRows = totalRowH + "px";
        document.documentElement.style.setProperty("--row-h", totalRowH + "px");

        // Keep original rankScroller padding calculation (year title height + wrapper margin)
        const yearTitleH = firstYearTitle.getBoundingClientRect().height;
        const wrapperMarginTop = parseFloat(
          getComputedStyle(firstAlbum.parentElement).marginTop || "0"
        );
        const rowsOffsetFixed = yearTitleH + wrapperMarginTop;
        rankScroller.style.paddingTop = rowsOffsetFixed + "px";

        // --- compute rows offset relative to yearsContainer so background starts at album top ---
        const yearsRect = yearsContainer.getBoundingClientRect();
        const firstAlbumRect = firstAlbum.getBoundingClientRect();
        const rowsOffsetForCSS = firstAlbumRect.top - yearsRect.top;
        document.documentElement.style.setProperty(
          "--rows-offset",
          Math.max(0, rowsOffsetForCSS) + "px"
        );

        // compute how many albums exist (global), but limit to 20 rows for the background
        const totalAlbums = document.querySelectorAll(
          "#rankScroller .rank-number"
        ).length;
        const rowsToCover = Math.min(totalAlbums, 20);
        const stripeCoverHeight = rowsToCover * totalRowH;

        // supply CSS variables used by the pseudo-background
        document.documentElement.style.setProperty(
          "--stripe-block",
          totalRowH * 20 + "px"
        ); // tile block (20 rows)
        document.documentElement.style.setProperty(
          "--stripe-cover",
          stripeCoverHeight + "px"
        ); // actual cover height (only up to row 20)
      }

      function createCoverImg(url) {
        const img = document.createElement("img");
        img.src = url;
        return img;
      }

      function createNoCover() {
        const div = document.createElement("div");
        div.className = "no-cover";
        div.innerText = "Album not on Spotify";
        return div;
      }

      function scrollToDecade(decadePrefix) {
        const container = document.getElementById("yearsContainer");
        const target = [...container.children].find((col) =>
          col.firstChild.innerText.startsWith(decadePrefix)
        );
        if (target) {
          target.scrollIntoView({ behavior: "smooth", inline: "start" });
        }
      }

      function playAlbum(uri) {
        if (!token) {
          alert("Please log in to Spotify first!");
          authenticateSpotify();
          return;
        }
        fetch(`https://api.spotify.com/v1/me/player/play`, {
          method: "PUT",
          body: JSON.stringify({ context_uri: uri }),
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
      }

      // ---------- UPDATED: use measured offset so rank column accounts for year-title height ----------
      function updateRankScrollerPosition() {
        const rankScroller = document.getElementById("rankScroller");
        const offset = parseFloat(rankScroller.dataset.offsetTop || 0);
        rankScroller.style.transform = `translateY(${
          offset - window.scrollY
        }px)`;
      }

      window.addEventListener("scroll", updateRankScrollerPosition, {
        passive: true,
      });
      window.addEventListener("resize", () => {
        // Re-measure on resize (fonts/line wrapping can subtly change)
        syncRankMetrics();
      });

      // 👇 keep the mobile scroll listener you added
      const _se =
        document.scrollingElement || document.documentElement || document.body;
      if (_se && _se !== window) {
        _se.addEventListener("scroll", updateRankScrollerPosition, {
          passive: true,
        });
      }

      window.onload = () => {
        token = getTokenFromUrl();
        fetchAlbums();
      };

      function getTokenFromUrl() {
        const hash = window.location.hash
          .substring(1)
          .split("&")
          .reduce((acc, item) => {
            const parts = item.split("=");
            acc[parts[0]] = decodeURIComponent(parts[1]);
            return acc;
          }, {});
        return hash.access_token;
      }

      function authenticateSpotify() {
        const scope =
          "user-modify-playback-state user-read-playback-state streaming";
        const authUrl = `https://accounts.spotify.com/authorize?client_id=${
          CONFIG.SPOTIFY_CLIENT_ID
        }&redirect_uri=${encodeURIComponent(
          CONFIG.REDIRECT_URI
        )}&scope=${encodeURIComponent(
          scope
        )}&response_type=token&show_dialog=true`;
        window.location = authUrl;
      }
    </script>
  </body>
</html>

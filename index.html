<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="music-icon-192x192.png">
<title>My Best Albums</title>

<style>
/* ===================== BASE STYLES ===================== */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #111;
  color: white;
  overflow-x: auto;
  overflow-y: auto;
}

/* -------------------- HEADER -------------------- */
header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 50px;
  background: #111;
  display: flex;
  align-items: center;
  padding: 0 20px;
  font-size: 20px;
  z-index: 100;
  gap: 15px;
  border-bottom: 2px solid #222;
}
.spacer { flex: 1; }
.login-btn {
  background: #1DB954;
  color: #000;
  border: none;
  padding: 6px 10px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 14px;
  font-weight: bold;
}
.decade-btn {
  background: #222;
  color: white;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: 3px;
  font-size: 14px;
}

/* -------------------- MAIN CONTAINER -------------------- */
.main-container {
  display: flex;
  margin-top: 0px;
}

/* -------------------- RANK COLUMN -------------------- */
.rank-column {
  position: fixed;
  left: 0;
  top: 50px;
  width: 30px;
  bottom: 64px; /* leave space for player bar */
  background: #111;
  z-index: 50;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
}
#rankScroller {
  will-change: transform;
  display: grid;
  grid-auto-rows: var(--row-h, 252px);
  padding-top: 0;
}
.rank-number {
  height: var(--row-h, 252px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #ffffff;
  box-sizing: border-box;
  width: 100%;
  position: relative;
  z-index: 5;
}

/* -------------------- YEAR COLUMNS -------------------- */
.years-container {
  display: flex;
  align-items: flex-start;
  padding: 0px 10px 80px 60px; /* leave bottom space for player bar */
  gap: 20px;
  position: relative;
}
.year-column {
  flex: 0 0 auto;
  width: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}
.year-title {
  position: sticky;
  top: 50px;
  font-size: 16px;
  font-weight: bold;
  background: #111;
  padding: 8px 5px;
  border-radius: 5px;
  text-align: center;
  width: 100%;
  z-index: 10;
}
.albums-wrapper {
  margin-top: 10px;
  padding-top: 50px;
  position: relative;
}
.album {
  width: 100%;
  height: auto;
  margin-top: 5px;
  margin-bottom: 0;
  cursor: pointer;
  position: relative;
  z-index: 6;
}
.album img,
.album .no-cover {
  width: 100%;
  height: 180px;
  display: block;
  padding: 0;
  margin: 0;
  border-radius: 8px;
  object-fit: cover;
  background: #222;
}
.album-info {
  height: 72px;
  margin: 0;
  padding-top: 4px;
  font-size: 13px;
  line-height: 18px;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

/* -------------------- MODAL -------------------- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal {
  width: 90%;
  max-width: 560px;
  background: #181818;
  border-radius: 12px;
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.modal-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.modal-header img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; }
.modal-title { display: flex; flex-direction: column; gap: 4px; }
.modal-title .name { font-weight: bold; }
.modal-title .artist { color: #ddd; font-size: 13px; }
.tracks { max-height: 60vh; overflow: auto; border-top: 1px solid #333; padding-top: 8px; }
.track { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 8px; cursor: pointer; }
.track:hover { background: #222; }
.modal-actions { display: flex; justify-content: flex-end; margin-top: 8px; }
.close-btn { background: #333; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }

/* -------------------- BOTTOM PLAYER BAR -------------------- */
.player-bar {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 0;
  width: 80%;
  max-width: 960px;
  height: 72px;
  background: #181818;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  z-index: 150;
  border-top: 1px solid #333;
  border-radius: 12px 12px 0 0;
  box-shadow: 0 -3px 10px rgba(0,0,0,0.5);
}
.track-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.track-info img { width: 48px; height: 48px; border-radius: 4px; object-fit: cover; }
.track-text { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
.track-name { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; }
.track-artist { font-size: 12px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.controls { display: flex; align-items: center; gap: 12px; flex: 1; justify-content: center; }
.ctrl-btn { background: #282828; color: #fff; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 16px; }
.ctrl-btn:hover { background: #3a3a3a; }

.progress-container { display: flex; align-items: center; gap: 6px; width: 300px; }
#progressBar { flex: 1; -webkit-appearance: none; height: 4px; background: #535353; border-radius: 2px; cursor: pointer; }
#progressBar::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #fff; cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.8); }
#progressBar::-moz-range-thumb { width: 12px; height: 12px; border-radius: 50%; background: #fff; cursor: pointer; box-shadow: 0 0 2px rgba(0,0,0,0.8); }
#currentTime, #totalTime { font-size: 10px; color: #ccc; width: 28px; text-align: center; }

/* ===================== MOBILE FIXES ===================== */
@media screen and (max-width: 768px) {
  /* Make rank-column and year sticky by JS (not just CSS) */
  .rank-column { position: sticky; top: 50px; left: 0; z-index: 100; }
  .years-container { padding-left: 40px; flex-wrap: nowrap; overflow-x: auto; }
  header { font-size: 18px; }
  .player-bar { width: 95%; }
  .progress-container { width: 200px; }
}
</style>
</head>
<body>
<header>
  Top Albums by Year
  <button class="decade-btn" onclick="scrollToDecade('199')">1990s</button>
  <button class="decade-btn" onclick="scrollToDecade('200')">2000s</button>
  <button class="decade-btn" onclick="scrollToDecade('201')">2010s</button>
  <button class="decade-btn" onclick="scrollToDecade('202')">2020s</button>
  <div class="spacer"></div>
  <button id="loginBtn" class="login-btn">Log in with Spotify</button>
</header>

<div class="main-container">
  <div class="rank-column" id="rankColumn">
    <div id="rankScroller"></div>
  </div>
  <div class="years-container" id="yearsContainer"></div>
</div>

<!-- Modal -->
<div id="albumModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <img id="modalCover" src="" alt="">
      <div class="modal-title">
        <div class="name" id="modalAlbumName"></div>
        <div class="artist" id="modalArtistName"></div>
      </div>
      <div style="margin-left:auto;">
        <button id="modalPlayBtn" class="login-btn" style="padding:6px 12px;">Play</button>
      </div>
    </div>
    <div class="tracks" id="tracksList"></div>
    <div class="modal-actions">
      <button id="closeModalBtn" class="close-btn">Close</button>
    </div>
  </div>
</div>

<!-- Bottom Player Bar -->
<div class="player-bar">
  <div class="track-info" id="barInfo">
    <img id="barCover" src="" alt="Album Cover" />
    <div class="track-text">
      <div id="barTrack" class="track-name">—</div>
      <div id="barArtist" class="track-artist">—</div>
    </div>
  </div>

  <div class="controls">
    <button id="prevBtn" class="ctrl-btn" title="Previous">⏮️</button>
    <button id="playPauseBtn" class="ctrl-btn" title="Play/Pause">▶️</button>
    <button id="nextBtn" class="ctrl-btn" title="Next">⏭️</button>
    <div class="progress-container">
      <span id="currentTime">0:00</span>
      <input type="range" id="progressBar" min="0" max="100" value="0">
      <span id="totalTime">0:00</span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
<script>
const CONFIG = {
  SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vS87YVlo7KZGqRzYWLfgmiyzu2SkcP3Rj0kmZb5yN3xqFbNDgBpmCY7hkrsVWsrwq1NlgGuZRg6uHR3/pub?gid=1476054055&single=true&output=csv",
  SPOTIFY_CLIENT_ID: "8d7b599ddbef4be296e05e04728908ce",
  REDIRECT_URI: "https://top-albums.netlify.app",
  BACKEND_FUNCTION_URL: "/.netlify/functions/spotify-auth"
};

let token = null;
let player = null;
let deviceId = null;
let albumsData = [];
let currentAlbumUri = null;

// -------------------- DATA LOAD --------------------
async function fetchAlbums() {
  try {
    const response = await fetch(CONFIG.SHEET_CSV_URL);
    const text = await response.text();
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        albumsData = results.data;
        renderAlbums();
      },
    });
  } catch (err) {
    console.error("Error fetching CSV:", err);
  }
}

function renderAlbums() {
  const container = document.getElementById("yearsContainer");
  const rankScroller = document.getElementById("rankScroller");
  container.innerHTML = "";
  rankScroller.innerHTML = "";

  const years = [...new Set(albumsData.map(a => a.Year))].sort();
  let globalRank = 1;

  years.forEach(year => {
    const yearCol = document.createElement("div");
    yearCol.className = "year-column";

    const yearDiv = document.createElement("div");
    yearDiv.className = "year-title";
    yearDiv.innerText = year;
    yearCol.appendChild(yearDiv);

    const albumsWrapper = document.createElement("div");
    albumsWrapper.className = "albums-wrapper";

    const albumsOfYear = albumsData
      .filter(a => a.Year === year)
      .sort((a,b)=>Number(a.Rank)-Number(b.Rank));

    albumsOfYear.forEach(a=>{
      const [artist, albumTitle] = (a["Album-Artist"]?.split(" - ") || ["Unknown","Unknown"]).map(s=>s.trim());
      const div = document.createElement("div");
      div.className = "album";

      const infoDiv = document.createElement("div");
      infoDiv.className = "album-info";
      infoDiv.innerHTML = `${albumTitle}<br><small>${artist}</small>`;

      const cover = a.CoverURL ? createCoverImg(a.CoverURL) : createNoCover();
      div.appendChild(cover);
      div.appendChild(infoDiv);

      div.onclick = ()=> openAlbumPopup(a, artist, albumTitle);

      albumsWrapper.appendChild(div);

      const rankDiv = document.createElement("div");
      rankDiv.className = "rank-number";
      rankDiv.innerText = globalRank++;
      rankScroller.appendChild(rankDiv);
    });

    yearCol.appendChild(albumsWrapper);
    container.appendChild(yearCol);
  });

  // Update ranks and offsets
  requestAnimationFrame(syncRankMetrics);
}

// -------------------- HELPERS --------------------
function createCoverImg(url){ const img = document.createElement("img"); img.src = url; return img; }
function createNoCover(){ const div = document.createElement("div"); div.className="no-cover"; div.innerText="Album not on Spotify"; return div; }
function scrollToDecade(decadePrefix){
  const container=document.getElementById("yearsContainer");
  const target=[...container.children].find(col=>col.firstChild.innerText.startsWith(decadePrefix));
  if(target)target.scrollIntoView({behavior:"smooth",inline:"start"});
}

// -------------------- SPOTIFY AUTH --------------------
const loginBtn = document.getElementById("loginBtn");
loginBtn.addEventListener("click", authenticateSpotify);

function generateRandomString(length){ /* PKCE code */ ... }
async function generateCodeChallenge(codeVerifier){ /* PKCE code */ ... }

function authenticateSpotify(){
  const codeVerifier=generateRandomString(128);
  localStorage.setItem("code_verifier",codeVerifier);
  generateCodeChallenge(codeVerifier).then(codeChallenge=>{
    const scope="user-modify-playback-state user-read-playback-state streaming";
    const authUrl=`https://accounts.spotify.com/authorize?response_type=code&client_id=${CONFIG.SPOTIFY_CLIENT_ID}&scope=${encodeURIComponent(scope)}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&code_challenge_method=S256&code_challenge=${codeChallenge}`;
    window.location=authUrl;
  });
}

async function handleAuthRedirect(){
  const params=new URLSearchParams(window.location.search);
  const code=params.get("code");
  const storedVerifier=localStorage.getItem("code_verifier");

  const existing = localStorage.getItem("spotify_access_token");
  if (existing) { token = existing; initPlayerIfPossible(); }

  if(code && storedVerifier){
    try{
      const res = await fetch(`${CONFIG.BACKEND_FUNCTION_URL}?code=${encodeURIComponent(code)}&verifier=${encodeURIComponent(storedVerifier)}`);
      const data = await res.json();
      if(data.access_token){
        token = data.access_token;
        localStorage.setItem("spotify_access_token", token);
        localStorage.removeItem("code_verifier");
        window.history.replaceState({},document.title,CONFIG.REDIRECT_URI);
        initPlayerIfPossible();
      } else console.error("Spotify token error:",data);
    } catch(err) { console.error(err); }
  }
}

// -------------------- SPOTIFY PLAYER --------------------
window.onSpotifyWebPlaybackSDKReady = () => { initPlayerIfPossible(); };

function initPlayerIfPossible(){
  if (!window.Spotify || !token) return;
  if (player) return;

  player = new Spotify.Player({
    name: 'Top Albums Web Player',
    getOAuthToken: cb => { cb(token); },
    volume: 0.7
  });

  // Error listeners
  player.addListener('initialization_error', ({ message }) => console.error('init_error', message));
  player.addListener('authentication_error', ({ message }) => console.error('auth_error', message));
  player.addListener('account_error', ({ message }) => console.error('account_error', message));
  player.addListener('playback_error', ({ message }) => console.error('playback_error', message));

  player.addListener('ready', ({ device_id }) => {
    console.log('Ready with Device ID', device_id);
    deviceId = device_id;
    localStorage.setItem("spotify_device_id", deviceId);
    transferPlaybackToDevice();
  });

  player.addListener('player_state_changed', state => {
    if (!state) return;
    updateBarFromState(state);
    // Update play/pause button
    document.getElementById('playPauseBtn').textContent = state.paused ? "▶️" : "⏸️";
  });

  player.connect();
}

async function transferPlaybackToDevice(){
  try {
    await fetch("https://api.spotify.com/v1/me/player", {
      method: "PUT",
      headers: { "Authorization": `Bearer ${token}`, "Content-Type":"application/json" },
      body: JSON.stringify({ device_ids: [deviceId], play: false })
    });
  } catch (e) { console.error(e); }
}

// -------------------- PROGRESS BAR --------------------
const barInfo = document.getElementById("barInfo");
const progressBar = document.getElementById("progressBar");
const currentTimeEl = document.getElementById("currentTime");
const totalTimeEl = document.getElementById("totalTime");

barInfo.addEventListener("click", () => { if (currentAlbumUri) showModal(); });

function updateBarFromState(state){
  const current = state.track_window.current_track;
  if (!current) return;

  const cover = current.album.images?.[0]?.url || "";
  document.getElementById("barCover").src = cover;
  document.getElementById("barTrack").textContent = current.name || "—";
  document.getElementById("barArtist").textContent = (current.artists?.[0]?.name) || "—";

  currentAlbumUri = current.album.uri;

  const duration = current.duration_ms;
  totalTimeEl.textContent = formatTime(duration);

  const pos = state.position;
  currentTimeEl.textContent = formatTime(pos);
  const progressPercent = Math.min(100, (pos / duration) * 100);
  progressBar.value = progressPercent;
}

// Animate progress bar every 500ms
setInterval(async () => {
  if (!player) return;
  const state = await player.getCurrentState();
  if (!state) return;
  updateBarFromState(state);
}, 500);

progressBar.addEventListener("input", async (e) => {
  if (!player) return;
  const percent = e.target.value;
  const state = await player.getCurrentState();
  if (!state) return;
  const duration = state.track_window.current_track.duration_ms;
  const newPos = Math.floor(duration * (percent / 100));
  player.seek(newPos);
});

function formatTime(ms){
  const totalSec = Math.floor(ms/1000);
  const mins = Math.floor(totalSec/60);
  const secs = totalSec % 60;
  return `${mins}:${secs.toString().padStart(2,'0')}`;
}

// -------------------- PLAYER CONTROLS --------------------
document.getElementById("playPauseBtn").addEventListener("click", () => { if (player) player.togglePlay(); });
document.getElementById("nextBtn").addEventListener("click", () => { if (player) player.nextTrack(); });
document.getElementById("prevBtn").addEventListener("click", () => { if (player) player.previousTrack(); });

// -------------------- MOBILE FIXES: SYNC RANKS --------------------
function syncRankMetrics(){
  // Get first album to calculate sizes
  const firstAlbum = document.querySelector(".albums-wrapper .album");
  const rankScroller = document.getElementById("rankScroller");
  const firstYearTitle = document.querySelector(".year-title");
  const yearsContainer = document.getElementById("yearsContainer");
  if(!firstAlbum || !rankScroller || !firstYearTitle || !yearsContainer) return;

  // Album height + margin
  const albumContentH = firstAlbum.getBoundingClientRect().height;
  const albumMarginTop = parseFloat(getComputedStyle(firstAlbum).marginTop || "0");
  const totalRowH = albumContentH + albumMarginTop;
  rankScroller.style.setProperty("--row-h", totalRowH+"px");

  const yearTitleH = firstYearTitle.getBoundingClientRect().height;
  const wrapperMarginTop = parseFloat(getComputedStyle(firstAlbum.parentElement).marginTop || "0");
  const rowsOffsetFixed = yearTitleH + wrapperMarginTop;
  rankScroller

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify Integration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #111; color: #fff;
    }
    header {
      background: #1db954; color: #fff;
      padding: 10px 20px;
    }
    .spotify-login {
      margin: 10px;
    }
    /* --- Player bar styling --- */
    #playerBar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #181818;
      display: flex;
      align-items: center;
      padding: 10px;
      border-top: 1px solid #333;
      color: #fff;
    }
    #barCover {
      width: 56px; height: 56px;
      margin-right: 10px;
      cursor: pointer;
    }
    #barInfo {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      cursor: pointer;
    }
    #barTrack {
      font-size: 14px;
    }
    #barArtist {
      font-size: 12px; color: #aaa;
    }
    #barControls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 0 20px;
    }
    #barControls button {
      background: none; border: none;
      color: #eee; font-size: 18px;
      cursor: pointer;
    }
    #barControls button:hover {
      color: #fff;
    }
    #progressContainer {
      flex: 2;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #progressBar {
      flex: 1;
      appearance: none;
      height: 4px;
      background: #333;
      border-radius: 2px;
      cursor: pointer;
    }
    #progressBar::-webkit-slider-thumb {
      appearance: none;
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
    }
    #currentTime, #totalTime {
      font-size: 11px; color: #bbb;
    }
    /* --- Modal popup --- */
    #albumModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      justify-content: center; align-items: center;
      z-index: 1000;
    }
    #albumContent {
      background: #222;
      padding: 20px;
      max-width: 500px;
      border-radius: 12px;
      overflow-y: auto;
      max-height: 80%;
    }
    .track {
      padding: 6px 0;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }
    .track:hover { background: #333; }
  </style>
</head>
<body>

  <header>
    <h1>Spotify Demo</h1>
    <button id="spotifyLoginBtn" class="spotify-login">Log in with Spotify</button>
    <span id="userInfo"></span>
  </header>

  <!-- Album modal -->
  <div id="albumModal">
    <div id="albumContent">
      <img id="modalCover" width="200" /><br>
      <h2 id="modalAlbumName"></h2>
      <h3 id="modalArtistName"></h3>
      <div id="tracksList"></div>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Bottom player bar -->
  <div id="playerBar">
    <img id="barCover" src="" alt="Cover">
    <div id="barInfo">
      <div id="barTrack">—</div>
      <div id="barArtist">—</div>
    </div>
    <div id="barControls">
      <button id="prevBtn">⏮</button>
      <button id="playPauseBtn">▶️</button>
      <button id="nextBtn">⏭</button>
    </div>
    <div id="progressContainer">
      <span id="currentTime">0:00</span>
      <input type="range" id="progressBar" min="0" max="100" value="0">
      <span id="totalTime">0:00</span>
    </div>
  </div>

  <!-- Spotify SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    let token = null;
    let deviceId = null;
    let currentAlbumUri = null;

    // Format ms → M:SS
    function formatTime(ms) {
      const m = Math.floor(ms/60000);
      const s = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    /* ===================== SPOTIFY AUTH ===================== */
    document.getElementById("spotifyLoginBtn").onclick = () => {
      window.location.href = "/.netlify/functions/auth";
    };

    async function getProfile() {
      const resp = await fetch("https://api.spotify.com/v1/me", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      return await resp.json();
    }

    async function onLogin() {
      const profile = await getProfile();
      document.getElementById("spotifyLoginBtn").style.display = "none";
      document.getElementById("userInfo").textContent = `Logged in as ${profile.display_name}`;
    }

    /* ===================== INIT PLAYER ===================== */
    function initPlayerIfPossible() {
      if (!window.Spotify) return;
      if (!token) return;

      const player = new Spotify.Player({
        name: 'Web Playback SDK',
        getOAuthToken: cb => { cb(token); },
        volume: 0.5
      });

      const barInfo = document.getElementById("barInfo");
      const progressBar = document.getElementById("progressBar");
      const currentTimeEl = document.getElementById("currentTime");
      const totalTimeEl = document.getElementById("totalTime");

      function updateBarFromState(state){
        const current = state.track_window.current_track;
        if (!current) return;

        const cover = current.album.images?.[0]?.url || "";
        document.getElementById("barCover").src = cover;
        document.getElementById("barTrack").textContent = current.name || "—";
        document.getElementById("barArtist").textContent = (current.artists?.[0]?.name) || "—";

        currentAlbumUri = current.album.uri;

        const duration = current.duration_ms;
        totalTimeEl.textContent = formatTime(duration);

        const pos = state.position;
        currentTimeEl.textContent = formatTime(pos);
        const progressPercent = Math.min(100, (pos / duration) * 100);
        progressBar.value = progressPercent;

        document.getElementById('playPauseBtn').textContent = state.paused ? "▶️" : "⏸️";
      }

      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        deviceId = device_id;
      });

      player.addListener('player_state_changed', state => {
        if (!state) return;
        updateBarFromState(state);
      });

      player.connect();
    }

    window.onSpotifyWebPlaybackSDKReady = () => {
      initPlayerIfPossible();
    };

    /* ===================== MODAL HANDLERS ===================== */
    function showModal(){ document.getElementById("albumModal").style.display = "flex"; }
    function closeModal(){ document.getElementById("albumModal").style.display = "none"; }

    function uriToId(uri){
      if(!uri) return null;
      const parts = uri.split(":");
      return parts[parts.length-1];
    }

    async function openAlbumPopup(albumRow, artist, albumTitle){
      if (!token) { authenticateSpotify(); return; }
      currentAlbumUri = albumRow.SpotifyURI || null;
      if (!currentAlbumUri) { alert("No Spotify album URI for this item."); return; }

      modalAlbumName.textContent = albumTitle || "—";
      modalArtistName.textContent = artist || "—";
      if (albumRow.CoverURL) modalCover.src = albumRow.CoverURL;

      tracksList.innerHTML = "Loading tracks…";
      const albumId = uriToId(currentAlbumUri);
      try {
        const resp = await fetch(`https://api.spotify.com/v1/albums/${albumId}/tracks?limit=50`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await resp.json();
        const items = data.items || [];

        if (!items.length) {
          tracksList.innerHTML = "<div style='color:#bbb'>No tracks found.</div>";
        } else {
          tracksList.innerHTML = "";
          items.forEach((t, idx) => {
            const div = document.createElement("div");
            div.className = "track";
            const mins = Math.floor((t.duration_ms||0)/60000);
            const secs = Math.floor(((t.duration_ms||0)%60000)/1000).toString().padStart(2,'0');
            div.innerHTML = `
              <div>#${(t.track_number||idx+1)} — ${t.name}</div>
              <div style="color:#aaa;font-size:12px;">${mins}:${secs}</div>
            `;
            div.onclick = () => startTrackPlayback(currentAlbumUri, t.uri);
            tracksList.appendChild(div);
          });
        }
      } catch (e) {
        console.error(e);
        tracksList.innerHTML = "<div style='color:#f77'>Failed to load tracks</div>";
      }
      showModal();
    }

    async function startTrackPlayback(albumUri, trackUri){
      if (!deviceId) { alert("Player not ready yet."); return; }
      try {
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
          method: "PUT",
          body: JSON.stringify({
            context_uri: albumUri,
            offset: { uri: trackUri },
            position_ms: 0
          }),
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });
      } catch (e) { console.error(e); }
    }

    /* ===================== PLAYER CONTROLS ===================== */
    document.getElementById("playPauseBtn").onclick = async () => {
      await fetch(`https://api.spotify.com/v1/me/player/${deviceId ? "pause" : "play"}?device_id=${deviceId}`, {
        method: "PUT",
        headers: { "Authorization": `Bearer ${token}` }
      });
    };

    document.getElementById("prevBtn").onclick = async () => {
      await fetch(`https://api.spotify.com/v1/me/player/previous?device_id=${deviceId}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      });
    };

    document.getElementById("nextBtn").onclick = async () => {
      await fetch(`https://api.spotify.com/v1/me/player/next?device_id=${deviceId}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      });
    };

    /* ===================== DATA LOAD ===================== */
    // Example: after login, set token = "<YOUR_ACCESS_TOKEN>" and call onLogin()
  </script>
</body>
</html>

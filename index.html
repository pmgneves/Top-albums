<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Best Albums</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #111;
        color: white;
        overflow-x: auto;
        overflow-y: auto;
      }
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: #111;
        display: flex;
        align-items: center;
        padding: 0 20px;
        font-size: 20px;
        z-index: 100;
        gap: 15px;
        border-bottom: 2px solid #222;
      }
      .decade-btn {
        background: #222;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 14px;
      }

      .main-container {
        display: flex;
        margin-top: 0px;
      }

      .rank-column {
        position: fixed;
        left: 0;
        top: 50px;
        width: 30px;
        bottom: 0;
        background: #111;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }

      /* CHANGED: grid so rows match album height; padding set by JS */
      #rankScroller {
        will-change: transform;
        display: grid;
        grid-auto-rows: var(--row-h, 252px);
        padding-top: 0; /* JS will set exact top offset */
      }

      /* CHANGED: row height driven by the same CSS var */
      .rank-number {
        height: var(--row-h, 252px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #ffffff;
        box-sizing: border-box;
        width: 100%;
      }

      .years-container {
        display: flex;
        align-items: flex-start;
        padding: 0px 10px 10px 60px;
        gap: 20px;
      }
      .year-column {
        flex: 0 0 auto;
        width: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      .year-title {
        position: sticky;
        top: 50px;
        font-size: 16px;
        font-weight: bold;
        background: #111;
        padding: 8px 5px;
        border-radius: 5px;
        text-align: center;
        width: 100%;
        z-index: 10;
      }

      .albums-wrapper {
        margin-top: 10px;
        padding-top: 60px; /* PUSH DOWN albums so they don't overlap sticky year-title */
      }

      .album {
        width: 100%;
        height: auto; /* let the content define the height */
        margin-bottom: 0; /* remove uncontrolled spacing */
        cursor: pointer;
      }

      .album img,
      .album .no-cover {
        width: 100%;
        height: 180px; /* fixed cover height */
        display: block; /* removes inline whitespace */
        padding: 0; /* no padding inside the box */
        margin: 0; /* no margin */
        border-radius: 8px;
      }

      .album-info {
        height: 72px; /* 4 lines: 18px each */
        margin: 0; /* remove margin-top: 3px */
        padding-top: 4px; /* small visual breathing space */
        font-size: 13px;
        line-height: 18px; /* exact line height */
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }
      /* Shared background for albums + rank numbers */
      .albums-wrapper .album:nth-child(1),
      #rankScroller .rank-number:nth-child(1) {
        background: rgba(212, 175, 55, 0.2); /* transparent gold */
        box-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
      }

      .albums-wrapper .album:nth-child(2),
      #rankScroller .rank-number:nth-child(2) {
        background: rgba(192, 192, 192, 0.2); /* transparent silver */
        box-shadow: 0 0 8px rgba(192, 192, 192, 0.5);
      }

      .albums-wrapper .album:nth-child(3),
      #rankScroller .rank-number:nth-child(3) {
        background: rgba(205, 127, 50, 0.2); /* transparent bronze */
        box-shadow: 0 0 8px rgba(205, 127, 50, 0.5);
      }

      .albums-wrapper .album:nth-child(n + 4):nth-child(-n + 10),
      #rankScroller .rank-number:nth-child(n + 4):nth-child(-n + 10) {
        background: rgba(173, 216, 230, 0.15); /* light blue */
        box-shadow: 0 0 6px rgba(173, 216, 230, 0.4);
      }

      .albums-wrapper .album:nth-child(n + 11):nth-child(-n + 20),
      #rankScroller .rank-number:nth-child(n + 11):nth-child(-n + 20) {
        background: rgba(100, 149, 237, 0.15); /* greyish blue */
        box-shadow: 0 0 6px rgba(100, 149, 237, 0.4);
      }
    </style>
  </head>
  <body>
    <header>
      Top Albums by Year
      <button class="decade-btn" onclick="scrollToDecade('199')">1990s</button>
      <button class="decade-btn" onclick="scrollToDecade('200')">2000s</button>
      <button class="decade-btn" onclick="scrollToDecade('201')">2010s</button>
      <button class="decade-btn" onclick="scrollToDecade('202')">2020s</button>
    </header>

    <div class="main-container">
      <div class="rank-column" id="rankColumn">
        <div id="rankScroller"></div>
      </div>

      <div class="years-container" id="yearsContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
      const CONFIG = {
        SHEET_CSV_URL:
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vS87YVlo7KZGqRzYWLfgmiyzu2SkcP3Rj0kmZb5yN3xqFbNDgBpmCY7hkrsVWsrwq1NlgGuZRg6uHR3/pub?gid=1476054055&single=true&output=csv",
        SPOTIFY_CLIENT_ID: "8d7b599ddbef4be296e05e04728908ce",
        REDIRECT_URI: "https://My-Best-Albums.com/",
      };

      let token = null;
      let albumsData = [];

      async function fetchAlbums() {
        try {
          const response = await fetch(CONFIG.SHEET_CSV_URL);
          const text = await response.text();
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              albumsData = results.data;
              renderAlbums();
            },
          });
        } catch (err) {
          console.error("Error fetching CSV:", err);
        }
      }

      function renderAlbums() {
        const container = document.getElementById("yearsContainer");
        const rankScroller = document.getElementById("rankScroller");
        container.innerHTML = "";
        rankScroller.innerHTML = "";

        const years = [...new Set(albumsData.map((a) => a.Year))].sort();
        let globalRank = 1;

        years.forEach((year) => {
          const yearCol = document.createElement("div");
          yearCol.className = "year-column";

          const yearDiv = document.createElement("div");
          yearDiv.className = "year-title";
          yearDiv.innerText = year;
          yearCol.appendChild(yearDiv);

          const albumsWrapper = document.createElement("div");
          albumsWrapper.className = "albums-wrapper";

          const albumsOfYear = albumsData
            .filter((a) => a.Year === year)
            .sort((a, b) => Number(a.Rank) - Number(b.Rank));

          albumsOfYear.forEach((a) => {
            const [artist, albumTitle] = (
              a["Album-Artist"]?.split(" - ") || ["Unknown", "Unknown"]
            ).map((s) => s.trim());
            const div = document.createElement("div");
            div.className = "album";

            let infoDiv = document.createElement("div");
            infoDiv.className = "album-info";
            infoDiv.innerHTML = `${albumTitle}<br><small>${artist}</small>`;

            div.appendChild(
              a.CoverURL ? createCoverImg(a.CoverURL) : createNoCover()
            );
            div.appendChild(infoDiv);
            div.onclick = () => playAlbum(a.SpotifyURI);

            albumsWrapper.appendChild(div);

            const rankDiv = document.createElement("div");
            rankDiv.className = "rank-number";
            rankDiv.innerText = globalRank++;
            rankScroller.appendChild(rankDiv);
          });

          yearCol.appendChild(albumsWrapper);
          container.appendChild(yearCol);
        });

        // After DOM is painted, measure and sync rank layout
        requestAnimationFrame(syncRankMetrics);
      }

      // Measure first album and sync rank scroller spacing & offset
      function syncRankMetrics() {
        const firstAlbum = document.querySelector(".albums-wrapper .album");
        const rankScroller = document.getElementById("rankScroller");
        const firstYearTitle = document.querySelector(".year-title");
        if (!firstAlbum || !rankScroller || !firstYearTitle) return;

        const albumH = Math.round(firstAlbum.getBoundingClientRect().height);
        rankScroller.style.setProperty("--row-h", albumH + "px");
        rankScroller.style.gridAutoRows = albumH + "px";

        // âœ… apply offset ONLY to rankScroller
        const yearTitleH = firstYearTitle.getBoundingClientRect().height;
        rankScroller.style.paddingTop = yearTitleH + "px";
      }

      function createCoverImg(url) {
        const img = document.createElement("img");
        img.src = url;
        return img;
      }

      function createNoCover() {
        const div = document.createElement("div");
        div.className = "no-cover";
        div.innerText = "Album not on Spotify";
        return div;
      }

      function scrollToDecade(decadePrefix) {
        const container = document.getElementById("yearsContainer");
        const target = [...container.children].find((col) =>
          col.firstChild.innerText.startsWith(decadePrefix)
        );
        if (target) {
          target.scrollIntoView({ behavior: "smooth", inline: "start" });
        }
      }

      function playAlbum(uri) {
        if (!token) {
          alert("Please log in to Spotify first!");
          authenticateSpotify();
          return;
        }
        fetch(`https://api.spotify.com/v1/me/player/play`, {
          method: "PUT",
          body: JSON.stringify({ context_uri: uri }),
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
      }

      // ---------- UPDATED: use measured offset so rank column accounts for year-title height ----------
      function updateRankScrollerPosition() {
        const rankScroller = document.getElementById("rankScroller");
        const offset = parseFloat(rankScroller.dataset.offsetTop || 0);
        rankScroller.style.transform = `translateY(${
          offset - window.scrollY
        }px)`;
      }

      window.addEventListener("scroll", updateRankScrollerPosition, {
        passive: true,
      });
      window.addEventListener("resize", () => {
        // Re-measure on resize (fonts/line wrapping can subtly change)
        syncRankMetrics();
      });

      // ðŸ‘‡ keep the mobile scroll listener you added
      const _se =
        document.scrollingElement || document.documentElement || document.body;
      if (_se && _se !== window) {
        _se.addEventListener("scroll", updateRankScrollerPosition, {
          passive: true,
        });
      }

      window.onload = () => {
        token = getTokenFromUrl();
        fetchAlbums();
      };

      function getTokenFromUrl() {
        const hash = window.location.hash
          .substring(1)
          .split("&")
          .reduce((acc, item) => {
            const parts = item.split("=");
            acc[parts[0]] = decodeURIComponent(parts[1]);
            return acc;
          }, {});
        return hash.access_token;
      }

      function authenticateSpotify() {
        const scope =
          "user-modify-playback-state user-read-playback-state streaming";
        const authUrl = `https://accounts.spotify.com/authorize?client_id=${
          CONFIG.SPOTIFY_CLIENT_ID
        }&redirect_uri=${encodeURIComponent(
          CONFIG.REDIRECT_URI
        )}&scope=${encodeURIComponent(
          scope
        )}&response_type=token&show_dialog=true`;
        window.location = authUrl;
      }
    </script>
  </body>
</html>
